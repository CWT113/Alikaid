# 加载三维数据

Cesium 支持大量的数据格式，主要分为一下几类：

- 影像地图：Bing、天地图、ArcGIS、OSM、WMTS、WMS
- 地形数据：ArcGIS、谷歌、STK
- 矢量数据：KML、KMZ、GeoJSON、TopoJSON、CZML
- 三维模型：GLTF、GLB（二进制GLTF文件）
- 三维瓦片：3D Tiles（倾斜摄影、人工模型、三维建筑物、CAD、BIM、点云数据等）



## [1. 影像地图](https://cesium.com/learn/cesiumjs/ref-doc/ImageryLayer.html)

### 1.1 [ArcGIS](https://cesium.com/learn/cesiumjs/ref-doc/ArcGisMapServerImageryProvider.html) 影像图

```js
const esri = Cesium.ImageryLayer.fromProviderAsync(
  Cesium.ArcGisMapServerImageryProvider.fromUrl(
    "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"
  ),
  {
    show: true
  }
);

// 1、在初始化时添加图层
const viewer = new Cesium.Viewer("cesiumContainer", {
  baseLayer: esri,
  infoBox: false
});

// 2、在运行时添加图层
viewer.imageryLayers.add(esri);
```



## 2. 地形数据





## 3. 矢量数据

### [3.1 kml / kmz](https://cesium.com/learn/cesiumjs/ref-doc/KmlDataSource.html?classFilter=KmlDataSource)

::: tip kmz 和 kml 的区别是什么？

1. `KML`是解压缩文件的文件扩展名，而`KMZ`是`KML`文件的压缩版本；

2. `KML`通常用于保存和存储地图位置，而`KMZ`则以相同的容量用于更具体的位置，例如地标；
3. 与`KMZ`相比，`KML`具有更大的文件空间和更长的数据传输。KMZ作为压缩或压缩文件具有较小的文件空间和大小；
4. `KML`可以被许多运行地图和图像(例如Google Earth和Google Maps)的地理浏览器或程序读取和识别，`KMZ`并不总是这样；

:::

Cesium 官方提供的了 kmz 数据，下载地址：[kmz 数据](https://github.com/CesiumGS/cesium/blob/main/Apps/SampleData/kml/gdpPerCapita2008.kmz)

```js
// 加载 kml 只需要换地址即可
const promise = Cesium.KmlDataSource.load("/kmz/gdpPerCapita2008.kmz", {
    camera: viewer.scene.camera,
    canvas: viewer.scene.canvas
});
viewer.dataSources.add(promise);
viewer.zoomTo(promise);
```



### [3.2 geojson](https://cesium.com/learn/cesiumjs/ref-doc/GeoJsonDataSource.html?classFilter=GeoJsonDataSource)

::: tip 提示

1.  `Cesium.GeoJsonDataSource.load(linestring)` 的返回值是一个 `Promise` 对象，所以可以使用 `.then` 方法。
2.  `viewer.dataSources.add()`可以接收一个 `Promise` 作为参数使用，因此可以将 `load` 方法的返回值作为参数。

:::

**加载 geojson**

1. 加载 turf 生成的线要素：

   ```js
   // 使用 turf 生成一条线
   const lineString = turf.lineString([
       [102.73176821728828, 38.02964680894118],
       [102.73330135753423, 38.02546206796032],
       [102.7356545495424, 38.02598166289124],
       [102.7360289209974, 38.02475990679443]
   ]);
   
   // 方式一
   const promise = Cesium.GeoJsonDataSource.load(lineString, {
       stroke: Cesium.Color.HOTPINK,
       strokeWidth: 5
   });
   promise.then(res => {
       const entity = viewer.entities.add(res.entities.values[0]);
       viewer.zoomTo(entity);
   });
   
   // 方式二(推荐)
   const promise = Cesium.GeoJsonDataSource.load(lineString, {
       stroke: Cesium.Color.HOTPINK,
       strokeWidth: 5
   });
   viewer.dataSources.add(promise);
   viewer.zoomTo(promise);
   ```

   

2. 加载本地 geojson 文件：

   ```js
   import geojson from "../data/geojson.json";
   
   const promise = Cesium.GeoJsonDataSource.load(geojson, {
       markerSize: 40, 							// 点图标大小(像素)
       markerSymbol: "?", 							// 点图标内部的默认符号
       markerColor: Cesium.Color.SKYBLUE, 			// 点图标颜色
       stroke: Cesium.Color.HOTPINK, 				// 线颜色
       strokeWidth: 5, 							// 线宽
       fill: Cesium.Color.SKYBLUE.withAlpha(0.5), 	// 填充颜色
       clampToGround: false 						// 是否贴地(当true时，多边形的外边线将会失效)
   });
   viewer.dataSources.add(promise);
   viewer.zoomTo(promise);
   ```

   

**删除 geojson**

```js {6}
import geojson from "../data/geojson.json";

onMounted(() => {
  const dataSource = await Cesium.GeoJsonDataSource.load(geojson, {
    clampToGround: true,
    fill: Cesium.Color.AZURE.withAlpha(0.5)
  });
  viewer.dataSources.add(dataSource);
  viewer.zoomTo(dataSource);
    
  setTimeout(() => {
    viewer.dataSources.remove(dataSource);
  }, 3000);
});
```



### 3.3 topojson

topojson 数据的加载方式和 geojson 的加载方式一样，都是使用 `Cesium.GeoJsonDataSource.load()` 方法。

在 Ceisum 官网[下载源代码](https://cesium.com/downloads/)，其中 Cesium-1.99\Apps\SampleData\ne_10m_us_states.topojson ，就是一个 topojson 数据。

```js
const promise = Cesium.GeoJsonDataSource.load(
  "/topojson/ne_10m_us_states.topojson",
  {
      markerSize: 40, 							// 点图标大小(像素)
      markerSymbol: "?", 							// 点图标内部的默认符号
      markerColor: Cesium.Color.SKYBLUE, 			// 点图标颜色
      stroke: Cesium.Color.HOTPINK, 				// 线颜色
      strokeWidth: 5, 							// 线宽
      fill: Cesium.Color.SKYBLUE.withAlpha(0.5), 	// 填充颜色
      clampToGround: false 						// 是否贴地(当true时，多边形的外边线将会失效)
  }
);
viewer.dataSources.add(promise);
viewer.zoomTo(promise);
```





## 4. 三维模型

### 4.1 加载 glb 模型

Cesium 官方提供了 glb 模型，下载地址：[glb 模型](https://github.com/CesiumGS/cesium/tree/main/Apps/SampleData/models/CesiumAir)

```js
const viewer = new Cesium.Viewer("cesiumContainer", {
    baseLayer: esri,
    infoBox: false,
    shouldAnimate: true, // 开启飞机动画
    shadows: true 		 // 开启飞机阴影
});

const position = Cesium.Cartesian3.fromDegrees(116.39, 38.9, 400.0);
// 设置飞机的俯仰角
const orientation = Cesium.Transforms.headingPitchRollQuaternion(
    position,
    new Cesium.HeadingPitchRoll(-90, 0, 0)
);

const entity = viewer.entities.add({
   position: position,
   orientation: orientation,
   model: {
      uri: "/glb/Cesium_Air.glb",
      minimumPixelSize: 200,
      maximumScale: 5000,
      show: true
   }
});

// 固定视角到飞机
viewer.camera.lookAt(
  position,
  new Cesium.HeadingPitchRange(Cesium.Math.toRadians(0), Cesium.Math.toRadians(-90), 500)
);
```
![Point](./images/airplane.png)




## 5. 三维瓦片

### [5.1 3D Tiles](https://cesium.com/learn/cesiumjs/ref-doc/Cesium3DTileset.html?classFilter=Cesium3DTileset)

在加载 3D Tiles 数据之前，可以先到 Cesium [官网](https://ion.cesium.com/assets/69380?page=1&sortBy=DATE_ADDED&sortOrder=DESC)添加 墨尔本和纽约 的在线数据。

1. 加载在线数据：

   ```js
   const tileset = viewer.scene.primitives.add(
       // 加载墨尔本建筑物3D Tiles
       await Cesium.Cesium3DTileset.fromIonAssetId(69380),
       // 加载纽约建筑物3D Tiles
       await Cesium.Cesium3DTileset.fromIonAssetId(75343),
       // 加载Google地球3D Tiles
       await Cesium.Cesium3DTileset.fromIonAssetId(2275207)
   );
   viewer.flyTo(tileset);
   ```

2. 加载离线数据，[详见参数配置](https://cesium.com/learn/cesiumjs/ref-doc/Cesium3DTileset.html#.ConstructorOptions)：

   ```js
   const tileset = await Cesium.Cesium3DTileset.fromUrl(
       "/3DTiles/b3dm/tileset.json",
       {
           enableCollision: true,
           skipLevelOfDetail: true,
           baseScreenSpaceError: 1024,
           skipScreenSpaceErrorFactor: 16,
           skipLevels: 1,
           immediatelyLoadDesiredLevelOfDetail: false,
           loadSiblings: false,
           cullWithChildrenBounds: true
       }
   );
   
   viewer.scene.primitives.add(tileset);
   viewer.flyTo(tileset);
   ```

   ::: tip 提示

   添加完模型后如果漂浮在空中，可以使用下面的代码调整模型贴地：
   
   ```js
   // 调整模型的高度偏移
   const heightOffset = -70;
   const boundingSphere = tileset.boundingSphere;
   const cartographic = Cesium.Cartographic.fromCartesian(boundingSphere.center);
   const surface = Cesium.Cartesian3.fromRadians(
       cartographic.longitude,
       cartographic.latitude,
       0.0
   );
   const offset = Cesium.Cartesian3.fromRadians(
       cartographic.longitude,
       cartographic.latitude,
       heightOffset
   );
   const translation = Cesium.Cartesian3.subtract(
       offset,
       surface,
       new Cesium.Cartesian3()
   );
   tileset.modelMatrix = Cesium.Matrix4.fromTranslation(translation);
   ```
   
   :::



































