# 加载三维数据

## [geojson](https://cesium.com/learn/cesiumjs/ref-doc/GeoJsonDataSource.html?classFilter=GeoJsonDataSource)

::: tip 提示

1.  `Cesium.GeoJsonDataSource.load(linestring)` 的返回值是一个 `Promise` 对象，所以可以使用 `.then` 方法。
2. `viewer.dataSources.add()`可以接收一个 `Promise` 作为参数使用，因此可以将 `load` 方法的返回值作为参数。

:::

### 加载 geojson

1. 加载 turf 生成的线要素：

   ```js
   // 使用 turf 生成一条线
   const lineString = turf.lineString([
       [102.73176821728828, 38.02964680894118],
       [102.73330135753423, 38.02546206796032],
       [102.7356545495424, 38.02598166289124],
       [102.7360289209974, 38.02475990679443]
   ]);
   
   // 方式一
   const promise = Cesium.GeoJsonDataSource.load(lineString, {
       stroke: Cesium.Color.HOTPINK,
       strokeWidth: 5
   });
   promise.then(res => {
       const entity = viewer.entities.add(res.entities.values[0]);
       viewer.zoomTo(entity);
   });
   
   // 方式二(推荐)
   const promise = Cesium.GeoJsonDataSource.load(lineString, {
       stroke: Cesium.Color.HOTPINK,
       strokeWidth: 5
   });
   viewer.dataSources.add(promise);
   viewer.zoomTo(promise);
   ```

   

2. 加载本地 geojson 文件：

   ```js
   import geojson from "../data/geojson.json";
   
   const promise = Cesium.GeoJsonDataSource.load(geojson, {
       markerSize: 40, 						// 点图标大小(像素)
       markerSymbol: "?", 						// 点图标内部的默认符号
       markerColor: Cesium.Color.SKYBLUE, 		// 点图标颜色
       stroke: Cesium.Color.HOTPINK, 			// 线颜色
       strokeWidth: 5, 						// 线宽
       fill: Cesium.Color.SKYBLUE.withAlpha(0.5), 	// 填充颜色
       clampToGround: false 						// 是否贴地(当true时，多边形的外边线将会失效)
   });
   viewer.dataSources.add(promise);
   viewer.zoomTo(promise);
   ```

   

3. 加载 geojson 面要素，并在开启 “贴地” 模式下，加载外边线和中心点图标：

   ```js
   /**
    * @description 加载geojson面数据
    */
   function loadGeojsonData() {
     const promise = Cesium.GeoJsonDataSource.load(geojson, {
       clampToGround: true, // 开启贴地之后，外边线会消失
       fill: Cesium.Color.AZURE.withAlpha(0.5)
     });
     viewer.dataSources.add(promise);
     viewer.zoomTo(promise);
   
     // 重新加载外边线
     const lineArr: any[] = [];
     geojson.features.map(feature => {
       if (feature.geometry && feature.geometry.coordinates) {
         feature.geometry.coordinates.map(coordinate => {
           // turf 把经纬度坐标转为多边形，再转为线要素
           const line = polygonToLine(polygon(coordinate));
           lineArr.push(line);
         });
       }
     });
   
     lineArr.map(line => {
       const outerLine = Cesium.GeoJsonDataSource.load(line, {
         clampToGround: true,
         stroke: Cesium.Color.AQUA,
         strokeWidth: 1
       });
       viewer.dataSources.add(outerLine);
     });
   }
   
   /**
    * @description 加载geojson点数据
    */
   function loadGeojsonPoint() {
     const pointGeoJson: FeatureCollection = {
       type: "FeatureCollection",
       features: []
     };
     geojson.features.map(feature => {
       pointGeoJson.features.push(
         point(feature.properties.center, feature.properties)
       );
       const promise = viewer.dataSources.add(
         Cesium.GeoJsonDataSource.load(pointGeoJson, {})
       );
       promise.then((dataSource: any) => {
         const entities = dataSource.entities.values;
         for (const item in entities) {
           const entity = entities[item];
           // 图标
           entity.billboard = {
             image: "/定位.svg",
             color: Cesium.Color.AQUA,
             width: 25,
             height: 25,
             heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
           };
           // 文字
           entity.label = {
             text: entity.name,
             font: "14px",
             pixelOffset: new Cesium.Cartesian3(0, 30, 0),
             fillColor: Cesium.Color.DARKGREEN
           };
         }
       });
     });
   }
   ```

   

### 删除 geojson

```js {7}
let dataSource: any;
onMounted(() => {
  // ...
  loadGeojsonData();
  setTimeout(() => {
    viewer.dataSources.remove(dataSource);
  }, 3000);
});

/**
 * @description 加载 geojson 数据
 */
async function loadGeojsonData() {
  dataSource = await Cesium.GeoJsonDataSource.load(geojson, {
    clampToGround: true,
    fill: Cesium.Color.AZURE.withAlpha(0.5)
  });
  viewer.dataSources.add(dataSource);
  viewer.zoomTo(dataSource);
}
```



## [3D Tiles](https://cesium.com/learn/cesiumjs/ref-doc/Cesium3DTileset.html?classFilter=Cesium3DTileset)

在加载 3D Tiles 数据之前，可以先到 Cesium [官网](https://ion.cesium.com/assets/69380?page=1&sortBy=DATE_ADDED&sortOrder=DESC)添加 墨尔本和纽约 的在线数据。

1. 加载在线数据：

   ```js
   const tileset = viewer.scene.primitives.add(
       // 加载墨尔本建筑物3D Tiles
       await Cesium.Cesium3DTileset.fromIonAssetId(69380),
       // 加载纽约建筑物3D Tiles
       await Cesium.Cesium3DTileset.fromIonAssetId(75343),
       // 加载Google地球3D Tiles
       await Cesium.Cesium3DTileset.fromIonAssetId(2275207)
   );
   ```

2. 加载离线数据，[详见参数配置](https://cesium.com/learn/cesiumjs/ref-doc/Cesium3DTileset.html#.ConstructorOptions)：

   ```js
   const tileset = await Cesium.Cesium3DTileset.fromUrl(
       "/3DTiles/b3dm/tileset.json",
       {
           enableCollision: true,
           skipLevelOfDetail: true,
           baseScreenSpaceError: 1024,
           skipScreenSpaceErrorFactor: 16,
           skipLevels: 1,
           immediatelyLoadDesiredLevelOfDetail: false,
           loadSiblings: false,
           cullWithChildrenBounds: true
       }
   );
   
   viewer.scene.primitives.add(tileset);
   viewer.flyTo(tileset);
   ```

   添加完模型后如果漂浮在空中，可以使用下面的代码调整模型贴地：

   ```js
   // 调整模型的高度偏移
   const heightOffset = -70;
   const boundingSphere = tileset.boundingSphere;
   const cartographic = Cesium.Cartographic.fromCartesian(boundingSphere.center);
   const surface = Cesium.Cartesian3.fromRadians(
       cartographic.longitude,
       cartographic.latitude,
       0.0
   );
   const offset = Cesium.Cartesian3.fromRadians(
       cartographic.longitude,
       cartographic.latitude,
       heightOffset
   );
   const translation = Cesium.Cartesian3.subtract(
       offset,
       surface,
       new Cesium.Cartesian3()
   );
   tileset.modelMatrix = Cesium.Matrix4.fromTranslation(translation);
   ```

   





































